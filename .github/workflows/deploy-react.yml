name: Deploy React App to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      target:
        description: 'Deployment target'
        required: true
        default: 'dhanayantri'
        type: choice
        options:
          - dhanayantri
          - campusplus360
          - greenbugdemo
          - asccendbta

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install dependencies
      run: npm install --prefix client

    - name: Build React app
      run: npm run build --prefix client

    - name: Set up SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

    - name: Set target directory based on input
      id: set-target-directory
      run: |
        case "${{ github.event.inputs.target }}" in
          dhanayantri) echo "TARGET_DIRECTORY=/var/www/html/DhanayantriIndia" >> $GITHUB_ENV ;;
          campusplus360) echo "TARGET_DIRECTORY=/var/www/html/superadmin" >> $GITHUB_ENV ;;
          greenbugdemo) echo "TARGET_DIRECTORY=/var/www/html/tekbizdemo.tekbizsoft.in" >> $GITHUB_ENV ;;
          asccendbta) echo "TARGET_DIRECTORY=/var/www/html/asccendbta.campusplus360.in" >> $GITHUB_ENV ;;
        esac

    - name: Deploy to EC2
      run: |
        rsync -avz --delete client/build/ ubuntu@${{ secrets.SERVER_IP }}:$TARGET_DIRECTORY || exit 1
        ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.SERVER_IP }} "sudo systemctl restart apache2 || exit 1"

    - name: Verify deployment
      run: ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.SERVER_IP }} "ls -la $TARGET_DIRECTORY"
